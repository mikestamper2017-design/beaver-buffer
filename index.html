<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #001f3f; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #ui-layer { position: absolute; top: 40px; width: 750px; display: flex; justify-content: space-between; color: #fff; pointer-events: none; z-index: 10; font-size: 42px; text-shadow: 4px 4px 8px #000; }
        .stat-label { font-size: 18px; display: block; color: #ffd700; text-transform: uppercase; }
        
        /* Overlays */
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,31,63,0.85); z-index: 100; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #end-screen { display: none; }
        button { padding: 20px 50px; font-size: 28px; font-weight: bold; cursor: pointer; border-radius: 50px; border: none; background: #ffd700; color: #001f3f; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        button:hover { background: #fff; }
    </style>
</head>
<body>
    <div id="start-screen" class="overlay">
        <h1 style="font-size: 60px; color: #ffd700;">BEAVER BUFFER</h1>
        <p style="font-size: 20px; margin-bottom: 30px;">Clear the pond before the game starts!</p>
        <button onclick="startGame()">BEGIN NOW, EH?</button>
    </div>

    <div id="ui-layer">
        <div><span class="stat-label">Timer</span><span id="timer">30</span></div>
        <div style="text-align: right;"><span class="stat-label">Polished</span><span id="score">0%</span></div>
    </div>

    <div id="end-screen" class="overlay">
        <div id="rank-title" style="font-size: 50px; color: #ffd700;"></div>
        <div id="rank-msg" style="font-size: 24px; margin-bottom: 30px;"></div>
        <button onclick="location.reload()">RE-BUFF THE ICE</button>
    </div>

<script>
    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 800,
        scene: { preload: preload, create: create, update: update }
    };

    const game = new Phaser.Game(config);
    let beaver, rt, pondMask, audioCtx;
    let timeLeft = 30;
    let totalCleaned = 0;
    let isGameOver = false;
    let gameStarted = false;

    function preload() {
        this.load.image('pond', 'pond.jpg?v=7'); 
        this.load.image('beaver', 'beaver.png?v=7');
        let graphics = this.make.graphics({ x: 0, y: 0, add: false });
        graphics.fillStyle(0xffffff, 1);
        graphics.fillCircle(40, 40, 40);
        graphics.generateTexture('brush', 80, 80);
    }

    function create() {
        this.add.image(400, 400, 'pond').setDisplaySize(800, 800);
        rt = this.make.renderTexture({ width: 800, height: 800 }, false);
        rt.fill(0xcceeff, 0.85);
        rt.setOrigin(0, 0);

        pondMask = new Phaser.Geom.Ellipse(400, 600, 650, 380);
        let shape = this.make.graphics();
        shape.fillStyle(0xffffff);
        shape.fillEllipse(pondMask.x, pondMask.y, pondMask.width, pondMask.height);
        rt.setMask(shape.createGeometryMask());

        beaver = this.add.sprite(400, 600, 'beaver').setScale(0.25);
        
        // Prepare Sound
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        gameStarted = true;
        
        // Start Timer
        game.scene.scenes[0].time.addEvent({
            delay: 1000,
            callback: () => {
                if (timeLeft > 0 && !isGameOver) {
                    timeLeft--;
                    document.getElementById('timer').innerText = timeLeft;
                } else if (!isGameOver) {
                    showEndScreen();
                }
            },
            callbackScope: game.scene.scenes[0], loop: true
        });
    }

    function playCrunchSound() {
        if (!audioCtx) return;
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.type = 'brownnoise'; // Using code-generated noise for ice crunch
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.01, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
    }

    function showEndScreen() {
        isGameOver = true;
        const screen = document.getElementById('end-screen');
        const title = document.getElementById('rank-title');
        const msg = document.getElementById('rank-msg');
        let score = Math.floor(totalCleaned);
        
        if (score < 40) { title.innerText = "OUT FOR A STROLL?"; msg.innerText = "Not too bad for a rookie, eh?"; }
        else if (score < 80) { title.innerText = "GOOD EFFORT, BUD!"; msg.innerText = "You're getting the hang of it!"; }
        else { title.innerText = "SOLID JOB, YA HOSER!"; msg.innerText = "That ice is pure glass!"; }
        
        screen.style.display = 'flex';
    }

    function update() {
        if (!gameStarted || isGameOver) return;
        let pointer = this.input.activePointer;
        if (pointer.isDown && pondMask.contains(pointer.x, pointer.y)) {
            // Faster tracking (0.5 instead of 0.2)
            beaver.x = Phaser.Math.Linear(beaver.x, pointer.x, 0.5);
            beaver.y = Phaser.Math.Linear(beaver.y, pointer.y, 0.5);
            
            if (navigator.vibrate) navigator.vibrate(5);
            playCrunchSound(); // Play the synthesized ice sound

            rt.erase('brush', beaver.x, beaver.y + 25);
            if (totalCleaned < 100) {
                totalCleaned += 0.3;
                document.getElementById('score').innerText = `${Math.floor(totalCleaned)}%`;
            }
        }
    }
</script>
</body>
</html>
