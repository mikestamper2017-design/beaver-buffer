<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Beaver Buffer: The Treenis Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #ui-layer { position: absolute; top: 15px; width: 90%; display: flex; justify-content: space-between; color: #fff; pointer-events: none; z-index: 10; font-size: 24px; text-shadow: 2px 2px 4px #000; }
        .stat-label { font-size: 10px; display: block; color: #ffd700; text-transform: uppercase; }
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,31,63,0.95); z-index: 100; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        button { padding: 15px 35px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 50px; border: none; background: #ffd700; color: #001f3f; transition: transform 0.1s; }
        button:active { transform: scale(0.9); }
        
        #chirp-display { 
            position: absolute; top: 70px; width: 100%; text-align: center; 
            color: #ffd700; font-size: 26px; font-style: italic; z-index: 20; 
            text-shadow: 2px 2px 8px #000; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; font-weight: bold;
        }
        .show-chirp { opacity: 1 !important; }

        #ad-popup { position: absolute; top: 20%; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; display: none; z-index: 50; border: 4px solid #ffd700; }
        #victory-screen a { color: #ffd700; text-decoration: none; font-size: 22px; display: block; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="chirp-display">Beauty!</div>
    <div id="ad-popup"><img src="sponsor-logo.png" style="height: 120px;"></div>

    <div id="start-screen" class="overlay">
        <h1 style="color: #ffd700; font-size: 40px; margin:0;">BEAVER BUFFER</h1>
        <p>Clear 85% of the ice to advance. Give 'er, bud!</p>
        <button onclick="startGame()">GIVE 'ER, EH?</button>
    </div>

    <div id="level-intro" class="overlay" style="display:none;">
        <h2 id="intro-title" style="color: #ffd700;">PROMOTED!</h2>
        <div id="intro-body" style="margin: 20px 0;"></div>
        <button onclick="proceedToLevel()">NEXT RINK</button>
    </div>

    <div id="fail-screen" class="overlay" style="display:none;">
        <h2 style="color: #ff4d4d;">OH, HOSER!</h2>
        <p>The ice is still a mess. The boys are gonna chirp ya!</p>
        <button onclick="location.reload()">TRY AGAIN</button>
    </div>

    <div id="victory-screen" class="overlay" style="display:none;">
        <h1 style="color: #ffd700;">ICE LEGEND!</h1>
        <img src="reward.png" style="width: 80%; max-width: 400px; border-radius: 15px; border: 4px solid #ffd700; margin-bottom:10px;">
        <p style="font-size:12px; margin:0;">PROUDLY SPONSORED BY</p>
        <a href="https://www.thetreenis.com" target="_blank">WWW.THETREENIS.COM</a>
        <button onclick="location.reload()" style="margin-top:15px;">PLAY AGAIN</button>
    </div>

    <div id="ui-layer">
        <div><span class="stat-label">Time</span><span id="timer">30</span></div>
        <div style="text-align: right;"><span class="stat-label">Ice Polished</span><span id="score">0%</span></div>
    </div>

<script>
    const config = {
        type: Phaser.AUTO, width: 800, height: 800,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics: { default: 'arcade' },
        scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);
    let beaver, rt, currentMask, goose, pucks, audioCtx, particles;
    let timeLeft = 30, gameStarted = false, currentLevel = 1;
    let cleanedTiles = new Set(), lastMilestone = 0, speedBoost = 0.25;
    const GRID_SIZE = 25;

    const phrases = [
        "Just a lick o' paint!", "Keep your stick on the ice!", "Right on, bud!", 
        "Lookin' sharp, eh?", "Beauty!", "Give 'er!", "Out fer a rip!", 
        "Hoser's workin' hard!", "Poutine power!", "Full send!", 
        "Holy Dinah!", "Absolute weapon!", "Wheel, snipe, celebrate!", 
        "Doin' the Lord's work!", "Puck-tastic!", "Certified Beauty!"
    ];

    function preload() {
        this.load.image('pond', 'pond.jpg'); this.load.image('rink', 'rink.jpg'); this.load.image('arena', 'arena.jpg');
        this.load.image('beaver', 'beaver.png'); this.load.image('beaver-cart', 'beaver-cart.png'); this.load.image('beaver-pro', 'beaver-pro.png');
        this.load.image('goose', 'goose.png'); this.load.image('puck', 'puck.png'); this.load.image('reward', 'reward.png');
        this.load.image('sponsor-logo', 'sponsor-logo.png');
        this.load.image('flare', 'https://labs.phaser.io/assets/particles/blue.png');
    }

    function create() {
        this.bg = this.add.image(400, 400, 'pond').setDisplaySize(800, 800);
        rt = this.make.renderTexture({ width: 800, height: 800 }, false);
        rt.fill(0xcceeff, 0.9);
        currentMask = new Phaser.Geom.Ellipse(400, 520, 720, 460);
        
        beaver = this.physics.add.sprite(400, 520, 'beaver').setScale(0.25).setDepth(5);
        goose = this.physics.add.sprite(-500, -500, 'goose').setScale(0.12);
        pucks = this.physics.add.group();
        
        particles = this.add.particles(0, 0, 'flare', {
            speed: 20, scale: { start: 0.1, end: 0 },
            blendMode: 'ADD', lifespan: 300, frequency: 10, emitting: false
        }).setDepth(1);

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function triggerChirp(customText) {
        const display = document.getElementById('chirp-display');
        display.innerText = customText || phrases[Math.floor(Math.random() * phrases.length)];
        display.classList.add('show-chirp');
        const duration = customText ? 3000 : 2000;
        setTimeout(() => display.classList.remove('show-chirp'), duration);
    }

    function playCrunch() {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(110, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        gameStarted = true;
    }

    function update(time, delta) {
        if (!gameStarted) return;
        timeLeft -= delta / 1000;
        document.getElementById('timer').innerText = Math.max(0, Math.ceil(timeLeft));

        let pointer = this.input.activePointer;
        if (pointer.isDown && currentMask.contains(pointer.x, pointer.y)) {
            beaver.x = Phaser.Math.Linear(beaver.x, pointer.x, speedBoost);
            beaver.y = Phaser.Math.Linear(beaver.y, pointer.y, speedBoost);
            
            let tx = Math.floor(beaver.x / GRID_SIZE);
            let ty = Math.floor(beaver.y / GRID_SIZE);
            let tileId = `${tx}_${ty}`;
            
            if (!cleanedTiles.has(tileId)) {
                cleanedTiles.add(tileId);
                rt.erase('beaver', beaver.x, beaver.y);
                let target = (currentLevel === 1) ? 350 : 450;
                let pct = Math.floor((cleanedTiles.size/target)*100);
                document.getElementById('score').innerText = `${Math.min(100, pct)}%`;
                
                if (pct >= lastMilestone + 10 && pct <= 100) {
                    lastMilestone = Math.floor(pct / 10) * 10;
                    
                    // Boost Announcements
                    if(currentLevel === 2 && pct === 50) {
                        triggerChirp("ðŸŸ POUTINE POWER! SPEED BOOST! ðŸŸ");
                        speedBoost = 0.5; beaver.setTint(0x00ff00);
                        setTimeout(() => { speedBoost = 0.25; beaver.clearTint(); }, 4000);
                    } else if (currentLevel === 2 && pct === 80) {
                        triggerChirp("ðŸ’ SECOND WIND! GIVE 'ER! ðŸ’");
                        speedBoost = 0.45; beaver.setTint(0xffff00);
                        setTimeout(() => { speedBoost = 0.25; beaver.clearTint(); }, 3000);
                    } else {
                        triggerChirp();
                    }
                }
                playCrunch();
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(10);
            }
        }

        if (currentLevel === 2) {
            this.physics.moveToObject(goose, beaver, 145);
            if (Phaser.Geom.Intersects.RectangleToRectangle(beaver.getBounds(), goose.getBounds())) {
                timeLeft -= 0.05;
                if (window.navigator.vibrate) window.navigator.vibrate(50);
            }
            if (beaver.y < 400) document.getElementById('ad-popup').style.display = 'block';
            else document.getElementById('ad-popup').style.display = 'none';
        }

        if (currentLevel === 3) {
            pucks.children.iterate(p => {
                if (p.x > 770 || p.x < 30) p.body.velocity.x *= -1;
                if (p.y > 770 || p.y < 200) p.body.velocity.y *= -1;
                if (Phaser.Geom.Intersects.RectangleToRectangle(beaver.getBounds(), p.getBounds())) {
                    timeLeft -= 0.15;
                    this.cameras.main.shake(100, 0.01);
                    if (window.navigator.vibrate) window.navigator.vibrate([30, 30, 30]);
                }
            });
        }
        if (timeLeft <= 0) handleEnd();
    }

    function handleEnd() {
        gameStarted = false;
        let score = parseInt(document.getElementById('score').innerText);
        if (score < 85) { document.getElementById('fail-screen').style.display = 'flex'; return; }
        if (currentLevel === 3) { document.getElementById('victory-screen').style.display = 'flex'; return; }

        document.getElementById('level-intro').style.display = 'flex';
        const body = document.getElementById('intro-body');
        let bonus = (score >= 100) ? "<div style='color:#ffd700; border:2px dashed #ffd700; padding:10px; margin-bottom:15px;'>ðŸ‡¨ðŸ‡¦ HOLY DINAH! 100% CLEAN! ðŸ‡¨ðŸ‡¦</div>" : "";
        
        if (currentLevel === 1) body.innerHTML = bonus + "Off to the Local Rink! Watch for the <b>Cobra Chicken</b>!";
        else body.innerHTML = bonus + "Big Leagues! Dodge the high-speed pucks, bud!";
    }

    function proceedToLevel() {
        document.getElementById('level-intro').style.display = 'none';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        currentLevel++; lastMilestone = 0;
        timeLeft = (currentLevel === 2) ? 45 : 40;
        cleanedTiles.clear();
        rt.clear(); rt.fill(0xcceeff, 0.9);
        document.getElementById('score').innerText = "0%";
        const scene = game.scene.scenes[0];
        if (currentLevel === 2) {
            scene.bg.setTexture('rink'); beaver.setTexture('beaver-cart').setScale(0.3);
            currentMask = new Phaser.Geom.Rectangle(80, 240, 640, 480);
            goose.setPosition(100, 300);
        } else if (currentLevel === 3) {
            scene.bg.setTexture('arena'); beaver.setTexture('beaver-pro').setScale(0.22);
            currentMask = new Phaser.Geom.Rectangle(40, 180, 720, 580);
            goose.setPosition(-900, -900);
            particles.start();
            for(let i=0; i<3; i++) {
                let p = pucks.create(200 + (i*200), 400, 'puck').setScale(0.12).setBounce(1);
                p.setVelocity(300 + (i*50), 300 - (i*50));
                particles.startFollow(p);
            }
        }
        gameStarted = true;
    }
</script>
</body>
</html>
