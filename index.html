<!DOCTYPE html>
<html lang="en">
<head>
   <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5ZMG859S');</script>
<!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Beaver Buffer">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>Beaver Buffer: The Treenis Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #ui-layer { position: absolute; top: 15px; width: 90%; display: flex; justify-content: space-between; color: #fff; pointer-events: none; z-index: 10; font-size: 24px; text-shadow: 2px 2px 4px #000; }
        .stat-label { font-size: 10px; display: block; color: #ffd700; text-transform: uppercase; }
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,31,63,0.95); z-index: 100; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        button { padding: 15px 35px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 50px; border: none; background: #ffd700; color: #001f3f; transition: transform 0.1s; margin: 10px; pointer-events: auto; }
        button:active { transform: scale(0.9); }
        .secondary-link { color: #ffd700; text-decoration: none; font-size: 16px; margin-top: 15px; border-bottom: 1px dashed #ffd700; padding-bottom: 2px; opacity: 0.8; pointer-events: auto; }
        #chirp-display { position: absolute; top: 70px; width: 100%; text-align: center; color: #ffd700; font-size: 26px; font-style: italic; z-index: 20; text-shadow: 2px 2px 8px #000; opacity: 0; transition: opacity 0.3s; pointer-events: none; font-weight: bold; }
        .show-chirp { opacity: 1 !important; }
        #ad-popup { position: absolute; top: 20%; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; display: none; z-index: 50; border: 4px solid #ffd700; max-width: 200px; pointer-events: none; }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5ZMG859S"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div id="chirp-display">Beauty!</div>
    <div id="ad-popup"><img src="sponsor-logo.png" style="width: 100%;"></div>

    <div id="start-screen" class="overlay">
        <h1 style="color: #ffd700; font-size: 40px; margin:0;">BEAVER BUFFER</h1>
        <p>Clear 85% of the ice to level up, bud!</p>
        <button id="start-btn">GIVE 'ER, EH?</button>
    </div>

    <div id="fail-screen" class="overlay" style="display:none;">
        <h2 style="color: #ff4d4d; margin-bottom: 5px;">TOUGH LUCK, HOSER!</h2>
        <p id="fail-stats" style="font-size: 24px; color: #ffd700; margin: 10px 0;"></p>
        <button onclick="location.reload()">TRY AGAIN</button>
        <a href="https://www.thetreenis.com" target="_blank" class="secondary-link" onclick="gtag('event', 'fail_shop_click')">Visit the Treenis Pro Shop</a>
    </div>

    <div id="level-intro" class="overlay" style="display:none;">
        <h2 id="intro-title" style="color: #ffd700;">PROMOTED!</h2>
        <div id="intro-body" style="margin: 20px 0;"></div>
        <button id="next-lvl-btn">NEXT RINK</button>
    </div>

    <div id="victory-screen" class="overlay" style="display:none;">
        <h1 style="color: #ffd700;">ICE LEGEND!</h1>
        <img src="reward.png" style="width: 80%; max-width: 400px; border-radius: 15px; border: 4px solid #ffd700; margin-bottom:10px;">
        <a href="https://www.thetreenis.com" target="_blank" style="color: #ffd700; font-size: 22px; text-decoration:none;" onclick="gtag('event', 'win_shop_click')">WWW.THETREENIS.COM</a>
        <button onclick="location.reload()" style="margin-top:15px;">PLAY AGAIN</button>
    </div>

    <div id="ui-layer">
        <div><span class="stat-label">Time</span><span id="timer">30</span></div>
        <div style="text-align: right;"><span class="stat-label">Ice Polished</span><span id="score">0%</span></div>
    </div>

<script>
    const config = {
        type: Phaser.AUTO, width: 800, height: 800,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics: { default: 'arcade' },
        scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);
    let beaver, rt, currentMask, goose, pucks, particles, puckSpawner;
    let timeLeft = 30, gameStarted = false, currentLevel = 1;
    let cleanedTiles = new Set(), lastMilestone = 0, speedBoost = 0.28;
    const GRID_SIZE = 22;

    // THE ULTIMATE CANADIAN CHIRP LIST
    const phrases = [
        "Beauty!", 
        "Give 'er!", 
        "Out fer a rip!", 
        "Poutine power!", 
        "Holy Dinah!", 
        "Absolute weapon!", 
        "Certified Beauty!", 
        "Right on, bud!", 
        "Keep your stick on the ice!",
        "What a tilly!", 
        "Wheel, snipe, celebrate!", 
        "Top shelf where grandma keeps the cookies!",
        "Full send!", 
        "Don't be a hoser!", 
        "Just a lick o' paint!", 
        "Straight cheddar!", 
        "Clap bombs, f**k moms!", 
        "Ferda!", 
        "Silky mitts!", 
        "Great hustle!", 
        "Real gully!",
        "Double-double energy!",
        "Heads up, puck's live!",
        "Pucks in deep!",
        "Game stick for you!",
        "Absolute clinic!",
        "Skate it off!",
        "Breezers are looking sharp!",
        "What a beaut!",
        "Bardown or bust!",
        "Doin' the Lord's work!",
        "Cleanest ice in the county!",
        "You're a legend, eh?",
        "Harder than a frozen puck!",
        "Look at the hands on this guy!"
    ];
    function doVibrate(ms) {
        if (window.navigator && window.navigator.vibrate) { window.navigator.vibrate(ms); }
    }

    function preload() {
        this.load.image('pond', 'pond.jpg'); this.load.image('rink', 'rink.jpg'); this.load.image('arena', 'arena.jpg');
        this.load.image('beaver', 'beaver.png'); this.load.image('beaver-cart', 'beaver-cart.png'); this.load.image('beaver-pro', 'beaver-pro.png');
        this.load.image('goose', 'goose.png'); this.load.image('puck', 'puck.png'); this.load.image('reward', 'reward.png');
        this.load.image('sponsor-logo', 'sponsor-logo.png');
        this.load.image('flare', 'https://labs.phaser.io/assets/particles/blue.png');
    }

    function create() {
        this.bg = this.add.image(400, 400, 'pond').setDisplaySize(800, 800);
        rt = this.make.renderTexture({ width: 800, height: 800 }, false);
        rt.fill(0xcceeff, 0.9);
        currentMask = new Phaser.Geom.Ellipse(400, 520, 720, 460);
        beaver = this.physics.add.sprite(400, 520, 'beaver').setScale(0.25).setDepth(5);
        goose = this.physics.add.sprite(-500, -500, 'goose').setScale(0.12);
        pucks = this.physics.add.group();
        particles = this.add.particles(0, 0, 'flare', { speed: 20, scale: { start: 0.1, end: 0 }, blendMode: 'ADD', lifespan: 300, frequency: 10, emitting: false }).setDepth(1);
        
        document.getElementById('start-btn').onclick = () => {
            gtag('event', 'game_start');
            document.getElementById('start-screen').style.display = 'none';
            doVibrate(50);
            gameStarted = true;
        };

        document.getElementById('next-lvl-btn').onclick = () => proceedToLevel();
    }

    function triggerChirp(customText) {
        const display = document.getElementById('chirp-display');
        display.innerText = customText || phrases[Math.floor(Math.random() * phrases.length)];
        display.classList.add('show-chirp');
        setTimeout(() => display.classList.remove('show-chirp'), 2000);
    }

    function spawnPuck() {
        if (currentLevel !== 3 || !gameStarted) return;
        const side = Phaser.Math.Between(0, 3);
        let x, y, vx, vy;
        if (side === 0) { x = 400; y = 150; vx = Phaser.Math.Between(-200, 200); vy = 350; }
        else if (side === 1) { x = 750; y = 400; vx = -350; vy = Phaser.Math.Between(-200, 200); }
        else if (side === 2) { x = 400; y = 750; vx = Phaser.Math.Between(-200, 200); vy = -350; }
        else { x = 50; y = 400; vx = 350; vy = Phaser.Math.Between(-200, 200); }
        
        let p = pucks.create(x, y, 'puck').setScale(0.08).setBounce(1).setCollideWorldBounds(true);
        p.body.setCircle(150);
        p.setVelocity(vx, vy);
        particles.startFollow(p);
        triggerChirp("ðŸš¨ SLAPSHOT! ðŸš¨"); // RESTORED
        doVibrate(20);
    }

    function update(time, delta) {
        if (!gameStarted) return;
        timeLeft -= delta / 1000;
        document.getElementById('timer').innerText = Math.max(0, Math.ceil(timeLeft));

        let pointer = this.input.activePointer;
        if (pointer.isDown && currentMask.contains(pointer.x, pointer.y)) {
            beaver.x = Phaser.Math.Linear(beaver.x, pointer.x, speedBoost);
            beaver.y = Phaser.Math.Linear(beaver.y, pointer.y, speedBoost);
            let tx = Math.floor(beaver.x / GRID_SIZE);
            let ty = Math.floor(beaver.y / GRID_SIZE);
            let tileId = `${tx}_${ty}`;
            
            if (!cleanedTiles.has(tileId)) {
                cleanedTiles.add(tileId);
                rt.erase(currentLevel === 3 ? 'beaver-pro' : 'beaver', beaver.x, beaver.y);
                let target = (currentLevel === 1) ? 380 : 480;
                let pct = Math.floor((cleanedTiles.size/target)*100);
                document.getElementById('score').innerText = `${Math.min(100, pct)}%`;
                if (cleanedTiles.size % 2 === 0) doVibrate(8);

                if (pct >= lastMilestone + 10 && pct <= 100) {
                    lastMilestone = Math.floor(pct / 10) * 10;
                    if(currentLevel === 2 && pct === 50) {
                        triggerChirp("ðŸŸ POUTINE POWER! ðŸŸ");
                        doVibrate([50, 30, 50]);
                        speedBoost = 0.55; beaver.setTint(0x00ff00);
                        setTimeout(() => { speedBoost = 0.28; beaver.clearTint(); }, 6000);
                    } else if (currentLevel === 2 && pct === 80) {
                        triggerChirp("ðŸ’ SECOND WIND! ðŸ’");
                        doVibrate(60);
                        speedBoost = 0.48; beaver.setTint(0xffff00);
                        setTimeout(() => { speedBoost = 0.28; beaver.clearTint(); }, 4000);
                    } else { triggerChirp(); }
                }
            }
        }

        if (currentLevel === 2) {
            this.physics.moveToObject(goose, beaver, 135);
            if (Phaser.Geom.Intersects.RectangleToRectangle(beaver.getBounds(), goose.getBounds())) {
                timeLeft -= 0.04;
                doVibrate(30);
            }
            // SPONSOR LOGO LOGIC
            if (beaver.y < 400) document.getElementById('ad-popup').style.display = 'block';
            else document.getElementById('ad-popup').style.display = 'none';
        }

        if (currentLevel === 3) {
            pucks.children.iterate(p => {
                if (Phaser.Geom.Intersects.CircleToRectangle(new Phaser.Geom.Circle(p.x, p.y, p.displayWidth/2), beaver.getBounds())) {
                    timeLeft -= 0.15;
                    this.cameras.main.shake(80, 0.008);
                    doVibrate([30, 30, 30]);
                }
            });
        }
        if (timeLeft <= 0) handleEnd();
    }

    function handleEnd() {
        gameStarted = false;
        if (puckSpawner) puckSpawner.remove();
        let finalScoreStr = document.getElementById('score').innerText;
        let scoreVal = parseInt(finalScoreStr);
        doVibrate(200);

        if (scoreVal < 85) {
            gtag('event', 'level_fail', { 'level': currentLevel, 'score': scoreVal });
            document.getElementById('fail-stats').innerText = `You polished ${finalScoreStr} of the ice!`;
            document.getElementById('fail-screen').style.display = 'flex';
            return;
        }
        
        // 100% SHOUT OUT & VICTORY LOGIC
        if (currentLevel === 3) { 
            gtag('event', 'game_complete', { 'final_score': scoreVal });
            document.getElementById('victory-screen').style.display = 'flex'; 
            return; 
        }
        
        gtag('event', 'level_clear', { 'level': currentLevel, 'score': scoreVal });
        document.getElementById('level-intro').style.display = 'flex';
        const body = document.getElementById('intro-body');
        let bonus = (scoreVal >= 100) ? "<div style='color:#ffd700; border:2px dashed #ffd700; padding:10px; margin-bottom:15px;'>ðŸ‡¨ðŸ‡¦ HOLY DINAH! 100% CLEAN! ðŸ‡¨ðŸ‡¦</div>" : "";
        body.innerHTML = bonus + (currentLevel === 1 ? "Watch out for the <b>Cobra Chicken</b>!" : "Big Leagues! Dodge the pucks!");
    }

    function proceedToLevel() {
        document.getElementById('level-intro').style.display = 'none';
        currentLevel++; 
        gtag('event', 'level_start', { 'level': currentLevel });
        lastMilestone = 0;
        timeLeft = (currentLevel === 2) ? 50 : 45;
        cleanedTiles.clear();
        rt.clear(); rt.fill(0xcceeff, 0.9);
        document.getElementById('score').innerText = "0%";
        const scene = game.scene.scenes[0];
        if (currentLevel === 2) {
            scene.bg.setTexture('rink'); beaver.setTexture('beaver-cart').setScale(0.3);
            currentMask = new Phaser.Geom.Rectangle(80, 240, 640, 480);
            goose.setPosition(100, 300);
        } else if (currentLevel === 3) {
            scene.bg.setTexture('arena'); beaver.setTexture('beaver-pro').setScale(0.15);
            currentMask = new Phaser.Geom.Rectangle(40, 180, 720, 580);
            goose.setPosition(-900, -900);
            pucks.clear(true, true);
            particles.start();
            spawnPuck();
            puckSpawner = scene.time.addEvent({ delay: 6000, callback: spawnPuck, callbackScope: scene, loop: true });
        }
        gameStarted = true;
    }
</script>
</body>
</html>
