<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beaver Buffer - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #001f3f; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #ui-layer { position: absolute; top: 20px; width: 90%; max-width: 750px; display: flex; justify-content: space-between; color: #fff; pointer-events: none; z-index: 10; font-size: 32px; text-shadow: 3px 3px 6px #000; }
        .stat-label { font-size: 14px; display: block; color: #ffd700; text-transform: uppercase; letter-spacing: 1px; }
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,31,63,0.95); z-index: 100; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .instruction-text { font-size: 18px; line-height: 1.4; margin: 20px 0; max-width: 500px; color: #e0e0e0; font-family: 'Arial', sans-serif; }
        .warning-text { color: #ff4d4d; font-weight: bold; font-size: 22px; text-transform: uppercase; margin-top: 10px; }
        button { padding: 15px 40px; font-size: 24px; font-weight: bold; cursor: pointer; border-radius: 50px; border: none; background: #ffd700; color: #001f3f; transition: transform 0.2s; box-shadow: 0 4px 0 #b89b00; }
        button:active { transform: translateY(4px); box-shadow: none; }
        #ad-popup { position: absolute; top: 100px; background: #fff; color: #d32f2f; padding: 8px 15px; border-radius: 5px; font-weight: bold; display: none; z-index: 20; border: 2px solid #000; font-size: 14px; }
    </style>
</head>
<body>

    <div id="ad-popup">SPONSORED BY THE TREENIS</div>

    <div id="start-screen" class="overlay">
        <h1 style="font-size: 50px; color: #ffd700; margin-bottom: 0;">BEAVER BUFFER</h1>
        <div class="instruction-text">
            <p>Grab your rake and give the pond a good scrape, bud!<br>
            Clear at least <strong>85%</strong> of the snow before time runs out.</p>
            <p><em>Use your finger to guide Buck across the ice.</em></p>
        </div>
        <button onclick="startGame()">BEGIN NOW, EH?</button>
    </div>

    <div id="level2-intro" class="overlay" style="display:none;">
        <h2 style="color: #ffd700; font-size: 40px;">PROMOTED!</h2>
        <div class="instruction-text">
            <p>You're at the Community Rink now. You've got the flooding cart, so she'll clear much wider.</p>
            <p class="warning-text">⚠️ WATCH OUT FOR THE COBRA TURKEY ⚠️</p>
            <p>The Goose is grumpy. If he nips at ya, it'll drain your time!</p>
        </div>
        <button onclick="startLevel2()">GIVE 'ER!</button>
    </div>

    <div id="ui-layer">
        <div><span class="stat-label">Time Left</span><span id="timer">30</span></div>
        <div style="text-align: right;"><span class="stat-label">Ice Polished</span><span id="score">0%</span></div>
    </div>

    <div id="end-screen" class="overlay" style="display:none;">
        <h2 id="rank-title" style="font-size: 45px;"></h2>
        <p id="rank-msg" style="font-size: 20px; margin-bottom: 30px;"></p>
        <button id="next-btn" onclick="nextLevel()" style="display:none;">NEXT LEVEL</button>
        <button id="retry-btn" onclick="location.reload()" style="display:none; background:#fff;">TRY AGAIN</button>
    </div>

<script>
    const config = {
        type: Phaser.AUTO,
        width: 800, height: 800,
        parent: 'game-container',
        scene: { preload: preload, create: create, update: update }
    };

    const game = new Phaser.Game(config);
    let beaver, rt, currentMask, goose, adPopup, crunchSound;
    let timeLeft = 30, totalCleaned = 0, gameStarted = false, currentLevel = 1;

    function preload() {
        this.load.image('pond', 'pond.jpg');
        this.load.image('rink', 'rink.jpg');
        this.load.image('beaver', 'beaver.png');
        this.load.image('beaver-cart', 'beaver-cart.png');
        this.load.image('goose', 'goose.png');
        
        // Brushes
        let graphics = this.make.graphics({ x: 0, y: 0, add: false });
        graphics.fillStyle(0xffffff, 1);
        graphics.fillCircle(40, 40, 40);
        graphics.generateTexture('brush', 80, 80);
        graphics.clear();
        graphics.fillRect(0, 0, 160, 55); 
        graphics.generateTexture('cart-brush', 160, 55);
    }

    function create() {
        this.bg = this.add.image(400, 400, 'pond').setDisplaySize(800, 800);
        rt = this.make.renderTexture({ width: 800, height: 800 }, false);
        rt.fill(0xcceeff, 0.9);
        
        // Level 1 Ellipse Mask
        currentMask = new Phaser.Geom.Ellipse(400, 600, 650, 380);
        let mShape = this.make.graphics().fillStyle(0xffffff).fillEllipse(400, 600, 650, 380);
        rt.setMask(mShape.createGeometryMask());

        beaver = this.add.sprite(400, 600, 'beaver').setScale(0.25);
        goose = this.add.sprite(-200, -200, 'goose').setScale(0.22);
        
        // Audio setup (Brown noise crunch)
        let ctx = new (window.AudioContext || window.webkitAudioContext)();
        let bufferSize = 4096;
        crunchSound = ctx.createScriptProcessor(bufferSize, 1, 1);
        crunchSound.onaudioprocess = function(e) {
            let output = e.outputBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = (Math.random() * 2 - 1) * 0.05; // Low volume crunch
            }
        };
        this.soundContext = ctx;
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        gameStarted = true;
    }

    function nextLevel() {
        document.getElementById('end-screen').style.display = 'none';
        document.getElementById('level2-intro').style.display = 'flex';
        gameStarted = false;
    }

    function startLevel2() {
        document.getElementById('level2-intro').style.display = 'none';
        currentLevel = 2;
        timeLeft = 25; 
        totalCleaned = 0;
        document.getElementById('score').innerText = '0%';
        
        game.scene.scenes[0].bg.setTexture('rink');
        beaver.setTexture('beaver-cart').setScale(0.32);
        
        // Rectangle Mask for Rink
        currentMask = new Phaser.Geom.Rectangle(100, 250, 600, 450);
        rt.fill(0xcceeff, 0.9);
        
        goose.setPosition(400, 400);
        gameStarted = true;
    }

    function showEndScreen() {
        gameStarted = false;
        const screen = document.getElementById('end-screen');
        const title = document.getElementById('rank-title');
        const msg = document.getElementById('rank-msg');
        let score = Math.floor(totalCleaned);
        
        screen.style.display = 'flex';
        if (score >= 85 && currentLevel === 1) {
            title.innerText = "BEAUTY, EH?";
            msg.innerText = "You cleared the pond! The Community Rink needs you.";
            document.getElementById('next-btn').style.display = 'block';
        } else if (score >= 95 && currentLevel === 2) {
            title.innerText = "ICE LEGEND!";
            msg.innerText = "The Treenis is polished to perfection. You're a pro!";
            document.getElementById('retry-btn').innerText = "PLAY AGAIN";
            document.getElementById('retry-btn').style.display = 'block';
        } else {
            title.innerText = "OUT FOR A STROLL?";
            msg.innerText = score + "% cleaned isn't gonna cut it. Give 'er another go!";
            document.getElementById('retry-btn').style.display = 'block';
        }
    }

    function update(time, delta) {
        if (!gameStarted) return;

        timeLeft -= delta / 1000;
        document.getElementById('timer').innerText = Math.max(0, Math.ceil(timeLeft));
        if (timeLeft <= 0) showEndScreen();

        let pointer = this.input.activePointer;
        if (pointer.isDown && currentMask.contains(pointer.x, pointer.y)) {
            // Smooth movement
            beaver.x = Phaser.Math.Linear(beaver.x, pointer.x, 0.4);
            beaver.y = Phaser.Math.Linear(beaver.y, pointer.y, 0.4);
            
            // Audio & Haptic
            if (time % 5 > 4 && window.navigator.vibrate) window.navigator.vibrate(5);
            if (this.soundContext.state === 'suspended') this.soundContext.resume();
            crunchSound.connect(this.soundContext.destination);

            let bType = (currentLevel === 1) ? 'brush' : 'cart-brush';
            rt.erase(bType, beaver.x, beaver.y + (currentLevel === 1 ? 20 : 40));
            
            if (totalCleaned < 100) {
                totalCleaned += (currentLevel === 1) ? 0.22 : 0.48;
                document.getElementById('score').innerText = `${Math.floor(totalCleaned)}%`;
            }

            // Treenis Ad Trigger
            if (currentLevel === 2 && beaver.y < 340) {
                document.getElementById('ad-popup').style.display = 'block';
            } else {
                document.getElementById('ad-popup').style.display = 'none';
            }
        } else {
            if (crunchSound) crunchSound.disconnect();
        }

        // Goose AI (Level 2 Only)
        if (currentLevel === 2) {
            goose.x = 400 + Math.cos(time / 500) * 260;
            goose.y = 475 + Math.sin(time / 900) * 140;
            
            if (Phaser.Geom.Intersects.RectangleToRectangle(beaver.getBounds(), goose.getBounds())) {
                timeLeft -= 0.08; 
                beaver.setTint(0xff0000);
            } else {
                beaver.clearTint();
            }
        }
    }
</script>
</body>
</html>
